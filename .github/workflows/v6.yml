name: V6 更新IP列表

on:
  schedule:
    - cron: '0 */6 * * *'   # 每6小时自动运行一次
  workflow_dispatch:         # 允许手动触发
  push:
    paths:
      - 'v6_collect_ips.py'  # 文件变更

jobs:
  update-ip-list:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3  # 检出仓库
      with:
        fetch-depth: 0  # 获取完整提交历史，避免强制推送冲突
      
    - name: 设置Python环境
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: 安装依赖
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4
        
    - name: 运行IPv6收集脚本
      run: python ${{ github.workspace }}/v6_collect_ips.py
        
    - name: 强制提交IPv6文件变更
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        if [ -n "$(git status --porcelain v6_ip.txt v6_ip_only.txt)" ]; then
          git add v6_ip.txt v6_ip_only.txt
          git commit -m "自动更新IPv6列表"
          git pull origin main --rebase  # 先尝试变基合并
          git push origin main --force   # 强制推送仅这两个文件
        else
          echo "IPv6文件无变更，跳过提交。"
        fi